# Hono 実装時の落とし穴と学習記録

## なぜこのドキュメントが必要か

このドキュメントは、Hono の実装中に私（Claude）が犯したミスと、その根本原因を記録したものです。
後続の LLM が同じ過ちを繰り返さないよう、具体的な失敗例と正しい理解を共有します。

## 私が陥った誤解と盲点

### 1. 曖昧な理解による場当たり的な対応

**問題の症状:**
- API が 404 を返す → `basePath` を追加してみる → エラー → 削除 → また別の方法を試す

**根本原因:**
- Hono と Next.js App Router の統合について、公式ドキュメントを確認せずに推測で実装していた
- 「たぶんこうだろう」という憶測に基づいて作業していた

**学習:**
- **必ず公式ドキュメントを確認する**
- 推測ではなく、実際の動作を確認する（デバッグログを入れる）

### 2. hono/client (`hc`) の理解不足

**私の誤解:**
```typescript
// ❌ 間違った理解: client.ts は不要だと思い込んだ
// 「直接 hc を使えばいい」と単純に考えていた
```

**実際の正しい理解:**
```typescript
// ✅ client.ts は Hono 公式のベストプラクティス
// 理由:
// 1. 型の事前計算によるパフォーマンス向上
// 2. 設定の一元管理
// 3. SSR/CSR での URL 切り替え
```

### 3. 型推論の仕組みを理解していなかった

**失敗例:**
```typescript
// 最初の間違ったアプローチ
export const battleroundsApi = new Hono();
battleroundsApi.get("/", handler);  // ❌ 型情報が失われる
```

**なぜ失敗したか:**
- Hono の型推論は**メソッドチェーン**に依存している
- チェーンを切ると、TypeScript は各ルートの型情報を追跡できなくなる

### 4. Next.js App Router の動作を誤解

**私の思い込み:**
- `/app/api/[[...route]]/route.ts` は `/api` プレフィックスを自動的に削除すると思っていた

**実際の動作:**
- Next.js は完全なパス（`/api/health` など）を Hono に渡す
- Hono 側で `/api` を含めてルーティングする必要がある

## 問題解決のアプローチの誤り

### 1. 試行錯誤の罠

**悪いパターン:**
```
1. エラーが出る
2. 適当に修正してみる
3. まだエラー
4. 別の修正を試す
5. （根本原因を理解しないまま繰り返す）
```

**正しいアプローチ:**
```
1. エラーが出る
2. デバッグログを入れて実際の動作を確認
3. 公式ドキュメントで正しい使い方を確認
4. 根本原因を理解してから修正
```

### 2. 型エラーへの対処

**悪い例:**
```typescript
// ❌ 型エラーを as any で握りつぶす
const client = hc(`${baseUrl}/api`) as any;
```

**良い例:**
```typescript
// ✅ なぜ型エラーが出るのか理解して修正
// 1. tsconfig.json の設定を確認
// 2. 型宣言ファイルの生成を確認
// 3. import パスの確認
```

## デバッグテクニック

### 1. リクエストパスの確認

```typescript
// 最も基本的で重要なデバッグ
app.use("*", async (c, next) => {
  console.log("Path:", c.req.path);
  console.log("URL:", c.req.url);
  return next();
});
```

### 2. 型情報の確認

```bash
# 生成された型宣言ファイルを直接確認
cat packages/api/dist/src/app.d.ts
```

### 3. 段階的な検証

```bash
# 1. まず型チェックが通るか
pnpm tsc --noEmit

# 2. ビルドが成功するか
pnpm build

# 3. 実際に動作するか
curl http://localhost:3000/api/health
```

## 重要な教訓

### 1. 「動けばいい」では不十分

- `as any` で型エラーを回避 → 後で必ず問題になる
- 根本原因を理解せずに進む → 同じ問題を繰り返す

### 2. ドキュメントの重要性

- 「たぶんこうだろう」ではなく、公式ドキュメントを確認
- 実装例を探して参考にする

### 3. デバッグの基本

- console.log は恥ではない、必須のツール
- 仮定ではなく、実際の動作を確認する

## 後続の LLM へのアドバイス

1. **Hono の実装を始める前に:**
   - 公式ドキュメントの RPC セクションを必ず読む
   - Next.js App Router のドキュメントも確認

2. **エラーが出たら:**
   - すぐに修正しようとせず、まず原因を理解する
   - デバッグログを入れて実際の動作を確認

3. **型エラーが出たら:**
   - `as any` は最終手段
   - tsconfig.json の設定を確認
   - 型宣言ファイルが正しく生成されているか確認

4. **統合テストは必須:**
   - ビルドが通る ≠ 動作する
   - 必ず実際の API エンドポイントをテストする

このドキュメントが、将来の実装者の時間を節約し、同じ失敗を防ぐことを願っています。